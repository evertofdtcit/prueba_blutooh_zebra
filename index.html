<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üñ®Ô∏è Web Serial API - Zebra Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 15px;
            background: #f5f5f5;
            font-size: 16px;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
            text-align: center;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        
        button {
            width: 100%;
            background: #007bff;
            color: white;
            border: none;
            padding: 15px;
            margin: 8px 0;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        button:hover { background: #0056b3; }
        button:disabled { 
            background: #6c757d; 
            cursor: not-allowed; 
        }
        
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .step {
            margin: 20px 0;
            padding: 15px;
            border: 2px solid #28a745;
            border-radius: 5px;
            background: #f8fff9;
        }
        
        .step h3 {
            margin-top: 0;
            color: #28a745;
        }
        
        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üñ®Ô∏è Web Serial API - Zebra ZD421</h1>
        <p style="text-align: center; color: #666;">Prueba de impresi√≥n serial directa</p>
        
        <div id="serialStatus" class="status info">
            ‚ÑπÔ∏è Verificando Web Serial API...
        </div>
        
        <div class="warning-box">
            <strong>‚ö†Ô∏è IMPORTANTE:</strong><br>
            1. <strong>Empareja tu Zebra ZD421</strong> con tu dispositivo desde Configuraci√≥n Bluetooth<br>
            2. <strong>Chrome/Edge √∫nicamente</strong> - Safari no soporta Web Serial<br>
            3. <strong>HTTPS requerido</strong> - localhost tambi√©n funciona
        </div>
        
        <div class="step">
            <h3>üîå PASO 1: Conectar Puerto Serial</h3>
            <button onclick="connectSerial()">üîó Buscar y Conectar Puerto Serial</button>
            <p><strong>Esto abrir√° un di√°logo para seleccionar tu Zebra emparejada</strong></p>
        </div>
        
        <div class="step">
            <h3>üñ®Ô∏è PASO 2: Pruebas de Impresi√≥n</h3>
            <button onclick="testPrint()" disabled id="testBtn">üìÑ Test Simple</button>
            <button onclick="testAdvanced()" disabled id="advancedBtn">üß™ Test Avanzado</button>
            <button onclick="printStatus()" disabled id="statusBtn">üìä Estado Impresora</button>
        </div>
        
        <div class="step">
            <h3>üìù PASO 3: Comando Personalizado</h3>
            <input type="text" id="customZpl" placeholder="Comando ZPL personalizado" value="^XA^FO50,50^A0N,30,30^FDWeb Serial!^FS^XZ">
            <button onclick="sendCustomZpl()" disabled id="customBtn">üì§ Enviar ZPL</button>
        </div>
        
        <div class="step">
            <h3>‚ùå Desconectar</h3>
            <button onclick="disconnectSerial()" disabled id="disconnectBtn">üîå Desconectar Puerto</button>
        </div>
        
        <div class="step">
            <h3>üìã Log de Actividad</h3>
            <button onclick="clearLog()">üóëÔ∏è Limpiar Log</button>
            <div id="log" class="log">Web Serial API iniciado...\n</div>
        </div>
    </div>

    <script>
        let port = null;
        let writer = null;
        let reader = null;
        
        function log(message) {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logEl.textContent += `[${timestamp}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(message);
        }
        
        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('serialStatus');
            statusEl.className = `status ${type}`;
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            statusEl.textContent = `${icons[type]} ${message}`;
        }
        
        function clearLog() {
            document.getElementById('log').textContent = 'Log limpio...\n';
        }
        
        function enableButtons(enable = true) {
            document.getElementById('testBtn').disabled = !enable;
            document.getElementById('advancedBtn').disabled = !enable;
            document.getElementById('statusBtn').disabled = !enable;
            document.getElementById('customBtn').disabled = !enable;
            document.getElementById('disconnectBtn').disabled = !enable;
        }
        
        // Verificar compatibilidad al cargar
        window.onload = function() {
            if ('serial' in navigator) {
                log('‚úÖ Web Serial API disponible');
                updateStatus('Web Serial API disponible - Listo para conectar', 'success');
            } else {
                log('‚ùå Web Serial API no disponible en este navegador');
                updateStatus('Web Serial API no soportado - Use Chrome/Edge', 'error');
            }
        };
        
        async function connectSerial() {
            try {
                log('üîç Solicitando puerto serial...');
                updateStatus('Abriendo selector de puertos...', 'info');
                
                // Solicitar puerto con filtros para dispositivos Bluetooth
                port = await navigator.serial.requestPort({
                    filters: [
                        // Filtros para dispositivos Bluetooth Serial
                        { bluetoothServiceClassId: 0x1101 }, // Serial Port Profile
                    ]
                });
                
                log('‚úÖ Puerto seleccionado');
                log(`üì± Puerto: ${port.getInfo ? JSON.stringify(port.getInfo()) : 'Info no disponible'}`);
                
                // Configurar puerto serial
                await port.open({ 
                    baudRate: 9600,    // Velocidad com√∫n para Zebra
                    dataBits: 8,
                    stopBits: 1,
                    parity: 'none',
                    flowControl: 'none'
                });
                
                log('üîå Puerto abierto con configuraci√≥n: 9600 baud, 8N1');
                
                // Obtener writer y reader
                writer = port.writable.getWriter();
                reader = port.readable.getReader();
                
                log('‚úÖ Escritor y lector obtenidos');
                updateStatus('Conectado - Listo para imprimir', 'success');
                
                enableButtons(true);
                
                // Iniciar lectura de respuestas (opcional)
                startReading();
                
            } catch (error) {
                log(`‚ùå Error conectando: ${error.message}`);
                updateStatus('Error de conexi√≥n', 'error');
                
                if (error.message.includes('No port selected')) {
                    log('‚ÑπÔ∏è Usuario cancel√≥ la selecci√≥n de puerto');
                } else if (error.message.includes('bluetooth')) {
                    log('üí° Tip: Aseg√∫rate de que la Zebra est√© emparejada en Bluetooth');
                }
            }
        }
        
        async function startReading() {
            try {
                while (port?.readable) {
                    const { value, done } = await reader.read();
                    if (done) {
                        break;
                    }
                    
                    // Decodificar respuesta de la impresora
                    const response = new TextDecoder().decode(value);
                    if (response.trim()) {
                        log(`üì® Respuesta: ${response.trim()}`);
                    }
                }
            } catch (error) {
                log(`üì® Lectura terminada: ${error.message}`);
            }
        }
        
        async function sendCommand(command) {
            if (!writer) {
                log('‚ùå No hay conexi√≥n serial activa');
                return false;
            }
            
            try {
                log(`üì§ Enviando: ${command}`);
                
                const encoder = new TextEncoder();
                const data = encoder.encode(command);
                
                await writer.write(data);
                
                log('‚úÖ Comando enviado por puerto serial');
                return true;
                
            } catch (error) {
                log(`‚ùå Error enviando comando: ${error.message}`);
                return false;
            }
        }
        
        async function testPrint() {
            log('\nüß™ Test Simple - Etiqueta b√°sica');
            const command = '^XA^FO50,50^A0N,30,30^FDTest Serial^FS^XZ';
            await sendCommand(command);
        }
        
        async function testAdvanced() {
            log('\nüß™ Test Avanzado - Con c√≥digo de barras');
            const command = `^XA
^FO50,50^A0N,25,25^FDWeb Serial API^FS
^FO50,100^BY2^BCN,70,Y,N,N^FD123456789^FS
^FO50,200^A0N,20,20^FD${new Date().toLocaleString()}^FS
^XZ`;
            await sendCommand(command);
        }
        
        async function printStatus() {
            log('\nüìä Solicitando estado de impresora');
            await sendCommand('~HS');
        }
        
        async function sendCustomZpl() {
            const command = document.getElementById('customZpl').value.trim();
            if (!command) {
                log('‚ùå Ingrese un comando ZPL');
                return;
            }
            
            log(`\nüìù Comando personalizado: ${command.substring(0, 30)}${command.length > 30 ? '...' : ''}`);
            await sendCommand(command);
        }
        
        async function disconnectSerial() {
            try {
                if (reader) {
                    await reader.cancel();
                    await reader.releaseLock();
                    reader = null;
                }
                
                if (writer) {
                    await writer.releaseLock();
                    writer = null;
                }
                
                if (port) {
                    await port.close();
                    port = null;
                }
                
                log('‚ùå Puerto serial desconectado');
                updateStatus('Desconectado', 'info');
                enableButtons(false);
                
            } catch (error) {
                log(`‚ùå Error desconectando: ${error.message}`);
            }
        }
        
        // Limpiar al cerrar la p√°gina
        window.addEventListener('beforeunload', disconnectSerial);
    </script>
</body>
</html>
